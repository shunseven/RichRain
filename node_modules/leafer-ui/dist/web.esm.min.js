import{Debug as t,LeaferCanvasBase as e,Platform as i,isString as s,DataHelper as n,canvasSizeAttrs as o,isUndefined as r,ResizeEvent as a,canvasPatch as h,FileHelper as l,Creator as c,LeaferImage as d,defineKey as u,LeafList as f,RenderEvent as p,ChildEvent as g,WatchEvent as _,PropertyEvent as w,LeafHelper as m,BranchHelper as v,LeafBoundsHelper as y,Bounds as x,isArray as b,LeafLevelList as S,LayoutEvent as L,Run as k,ImageManager as B,PointHelper as T,BoundsHelper as E,Plugin as P,MathHelper as R,isObject as M,FourNumberHelper as C,Matrix as A,ImageEvent as O,MatrixHelper as D,AlignHelper as W,isNumber as I,getMatrixData as F,AroundHelper as z,Direction4 as j}from"@leafer/core";export*from"@leafer/core";export{LeaferImage}from"@leafer/core";import{InteractionHelper as U,InteractionBase as G,Cursor as Y,HitCanvasManager as X}from"@leafer-ui/core";export*from"@leafer-ui/core";import{Paint as V,PaintImage as N,ColorConvert as q,PaintGradient as H,Effect as K,Group as Q,TextConvert as $}from"@leafer-ui/draw";var Z;!function(t){t[t.none=1]="none",t[t.free=2]="free",t[t.mirrorAngle=3]="mirrorAngle",t[t.mirror=4]="mirror"}(Z||(Z={}));const J=t.get("LeaferCanvas");class tt extends e{set zIndex(t){const{style:e}=this.view;e.zIndex=t,this.setAbsolute(this.view)}set childIndex(t){const{view:e,parentView:i}=this;if(e&&i){const s=i.children[t];s?(this.setAbsolute(s),i.insertBefore(e,s)):i.appendChild(s)}}init(){const{config:t}=this,e=t.view||t.canvas;e?this.__createViewFrom(e):this.__createView();const{style:s}=this.view;if(s.display||(s.display="block"),this.parentView=this.view.parentElement,this.parentView){const t=this.parentView.style;t.webkitUserSelect=t.userSelect="none",this.view.classList.add("leafer-canvas-view")}i.syncDomFont&&!this.parentView&&(s.display="none",document.body&&document.body.appendChild(this.view)),this.__createContext(),this.autoLayout||this.resize(t)}set backgroundColor(t){this.view.style.backgroundColor=t}get backgroundColor(){return this.view.style.backgroundColor}set hittable(t){this.view.style.pointerEvents=t?"auto":"none"}get hittable(){return"none"!==this.view.style.pointerEvents}__createView(){this.view=document.createElement("canvas")}__createViewFrom(t){let e=s(t)?document.getElementById(t):t;if(e)if(e instanceof HTMLCanvasElement)this.view=e;else{let t=e;if(e===window||e===document){const e=document.createElement("div"),{style:i}=e;i.position="absolute",i.top=i.bottom=i.left=i.right="0px",document.body.appendChild(e),t=e}this.__createView();const i=this.view;t.hasChildNodes()&&(this.setAbsolute(i),t.style.position||(t.style.position="relative")),t.appendChild(i)}else J.error(`no id: ${t}`),this.__createView()}setAbsolute(t){const{style:e}=t;e.position="absolute",e.top=e.left="0px"}updateViewSize(){const{width:t,height:e,pixelRatio:i}=this,{style:s}=this.view;s.width=t+"px",s.height=e+"px",this.unreal||(this.view.width=Math.ceil(t*i),this.view.height=Math.ceil(e*i))}updateClientBounds(){this.view.parentElement&&(this.clientBounds=this.view.getBoundingClientRect())}startAutoLayout(t,e){if(this.resizeListener=e,t){if(this.autoBounds=t,this.resizeObserver)return;try{this.resizeObserver=new ResizeObserver(t=>{this.updateClientBounds();for(const e of t)this.checkAutoBounds(e.contentRect)});const t=this.parentView;t?(this.resizeObserver.observe(t),this.checkAutoBounds(t.getBoundingClientRect())):(this.checkAutoBounds(this.view),J.warn("no parent"))}catch(t){this.imitateResizeObserver()}this.stopListenPixelRatio()}else this.listenPixelRatio(),this.unreal&&this.updateViewSize()}imitateResizeObserver(){this.autoLayout&&(this.parentView&&this.checkAutoBounds(this.parentView.getBoundingClientRect()),i.requestRender(this.imitateResizeObserver.bind(this)))}listenPixelRatio(){this.windowListener||window.addEventListener("resize",this.windowListener=()=>{const t=i.devicePixelRatio;if(!this.config.pixelRatio&&this.pixelRatio!==t){const{width:e,height:i}=this;this.emitResize({width:e,height:i,pixelRatio:t})}})}stopListenPixelRatio(){this.windowListener&&(window.removeEventListener("resize",this.windowListener),this.windowListener=null)}checkAutoBounds(t){const e=this.view,{x:s,y:n,width:o,height:r}=this.autoBounds.getBoundsFrom(t),a={width:o,height:r,pixelRatio:this.config.pixelRatio?this.pixelRatio:i.devicePixelRatio};if(!this.isSameSize(a)){const{style:t}=e;t.marginLeft=s+"px",t.marginTop=n+"px",this.emitResize(a)}}stopAutoLayout(){this.autoLayout=!1,this.resizeObserver&&this.resizeObserver.disconnect(),this.resizeListener=this.resizeObserver=null}emitResize(t){const e={};n.copyAttrs(e,this,o),this.resize(t),this.resizeListener&&!r(this.width)&&this.resizeListener(new a(t,e))}unrealCanvas(){if(!this.unreal&&this.parentView){let t=this.view;t&&t.remove(),t=this.view=document.createElement("div"),this.parentView.appendChild(this.view),t.classList.add("leafer-app-view"),this.unreal=!0}}destroy(){const{view:t}=this;t&&(this.stopAutoLayout(),this.stopListenPixelRatio(),t.parentElement&&t.remove(),super.destroy())}}h(CanvasRenderingContext2D.prototype),h(Path2D.prototype);const{mineType:et,fileType:it}=l;function st(t,e){i.origin={createCanvas(t,e){const i=document.createElement("canvas");return i.width=t,i.height=e,i},canvasToDataURL:(t,e,i)=>{const s=et(e),n=t.toDataURL(s,i);return"image/bmp"===s?n.replace("image/png;","image/bmp;"):n},canvasToBolb:(t,e,i)=>new Promise(s=>t.toBlob(s,et(e),i)),canvasSaveAs:(t,e,s)=>{const n=t.toDataURL(et(it(e)),s);return i.origin.download(n,e)},download:(t,e)=>new Promise(i=>{let s=document.createElement("a");s.href=t,s.download=e,document.body.appendChild(s),s.click(),document.body.removeChild(s),i()}),loadImage:t=>new Promise((e,s)=>{const n=new i.origin.Image,{crossOrigin:o}=i.image;o&&(n.setAttribute("crossOrigin",o),n.crossOrigin=o),n.onload=()=>{e(n)},n.onerror=t=>{s(t)},n.src=i.image.getRealURL(t)}),Image:Image,PointerEvent:PointerEvent,DragEvent:DragEvent},i.event={stopDefault(t){t.preventDefault()},stopNow(t){t.stopImmediatePropagation()},stop(t){t.stopPropagation()}},i.canvas=c.canvas(),i.conicGradientSupport=!!i.canvas.context.createConicGradient}Object.assign(c,{canvas:(t,e)=>new tt(t,e),image:t=>new d(t)}),i.name="web",i.isMobile="ontouchstart"in window,i.requestRender=function(t){window.requestAnimationFrame(t)},u(i,"devicePixelRatio",{get:()=>devicePixelRatio});const{userAgent:nt}=navigator;nt.indexOf("Firefox")>-1?(i.conicGradientRotate90=!0,i.intWheelDeltaY=!0,i.syncDomFont=!0):(/iPhone|iPad|iPod/.test(navigator.userAgent)||/Macintosh/.test(navigator.userAgent)&&/Version\/[\d.]+.*Safari/.test(navigator.userAgent))&&(i.fullImageShadow=!0),nt.indexOf("Windows")>-1?(i.os="Windows",i.intWheelDeltaY=!0):nt.indexOf("Mac")>-1?i.os="Mac":nt.indexOf("Linux")>-1&&(i.os="Linux");class ot{get childrenChanged(){return this.hasAdd||this.hasRemove||this.hasVisible}get updatedList(){if(this.hasRemove&&this.config.usePartLayout){const t=new f;return this.__updatedList.list.forEach(e=>{e.leafer&&t.add(e)}),t}return this.__updatedList}constructor(t,e){this.totalTimes=0,this.config={},this.__updatedList=new f,this.target=t,e&&(this.config=n.default(e,this.config)),this.__listenEvents()}start(){this.disabled||(this.running=!0)}stop(){this.running=!1}disable(){this.stop(),this.__removeListenEvents(),this.disabled=!0}update(){this.changed=!0,this.running&&this.target.emit(p.REQUEST)}__onAttrChange(t){this.config.usePartLayout&&this.__updatedList.add(t.target),this.update()}__onChildEvent(t){this.config.usePartLayout&&(t.type===g.ADD?(this.hasAdd=!0,this.__pushChild(t.child)):(this.hasRemove=!0,this.__updatedList.add(t.parent))),this.update()}__pushChild(t){this.__updatedList.add(t),t.isBranch&&this.__loopChildren(t)}__loopChildren(t){const{children:e}=t;for(let t=0,i=e.length;t<i;t++)this.__pushChild(e[t])}__onRquestData(){this.target.emitEvent(new _(_.DATA,{updatedList:this.updatedList})),this.__updatedList=new f,this.totalTimes++,this.changed=this.hasVisible=this.hasRemove=this.hasAdd=!1}__listenEvents(){this.__eventIds=[this.target.on_([[w.CHANGE,this.__onAttrChange,this],[[g.ADD,g.REMOVE],this.__onChildEvent,this],[_.REQUEST,this.__onRquestData,this]])]}__removeListenEvents(){this.target.off_(this.__eventIds)}destroy(){this.target&&(this.stop(),this.__removeListenEvents(),this.target=this.__updatedList=null)}}const{updateAllMatrix:rt,updateBounds:at,updateChange:ht}=m,{pushAllChildBranch:lt,pushAllParent:ct}=v;const{worldBounds:dt}=y;class ut{constructor(t){this.updatedBounds=new x,this.beforeBounds=new x,this.afterBounds=new x,b(t)&&(t=new f(t)),this.updatedList=t}setBefore(){this.beforeBounds.setListWithFn(this.updatedList.list,dt)}setAfter(){this.afterBounds.setListWithFn(this.updatedList.list,dt),this.updatedBounds.setList([this.beforeBounds,this.afterBounds])}merge(t){this.updatedList.addList(t.updatedList.list),this.beforeBounds.add(t.beforeBounds),this.afterBounds.add(t.afterBounds),this.updatedBounds.add(t.updatedBounds)}destroy(){this.updatedList=null}}const{updateAllMatrix:ft,updateAllChange:pt}=m,gt=t.get("Layouter");class _t{constructor(t,e){this.totalTimes=0,this.config={usePartLayout:!0},this.__levelList=new S,this.target=t,e&&(this.config=n.default(e,this.config)),this.__listenEvents()}start(){this.disabled||(this.running=!0)}stop(){this.running=!1}disable(){this.stop(),this.__removeListenEvents(),this.disabled=!0}layout(){if(this.layouting||!this.running)return;const{target:t}=this;this.times=0;try{t.emit(L.START),this.layoutOnce(),t.emitEvent(new L(L.END,this.layoutedBlocks,this.times))}catch(t){gt.error(t)}this.layoutedBlocks=null}layoutAgain(){this.layouting?this.waitAgain=!0:this.layoutOnce()}layoutOnce(){return this.layouting?gt.warn("layouting"):this.times>3?gt.warn("layout max times"):(this.times++,this.totalTimes++,this.layouting=!0,this.target.emit(_.REQUEST),this.totalTimes>1&&this.config.usePartLayout?this.partLayout():this.fullLayout(),this.layouting=!1,void(this.waitAgain&&(this.waitAgain=!1,this.layoutOnce())))}partLayout(){var t;if(!(null===(t=this.__updatedList)||void 0===t?void 0:t.length))return;const e=k.start("PartLayout"),{target:i,__updatedList:s}=this,{BEFORE:n,LAYOUT:o,AFTER:r}=L,a=this.getBlocks(s);a.forEach(t=>t.setBefore()),i.emitEvent(new L(n,a,this.times)),this.extraBlock=null,s.sort(),function(t,e){let i;t.list.forEach(t=>{i=t.__layout,e.without(t)&&!i.proxyZoom&&(i.matrixChanged?(rt(t,!0),e.add(t),t.isBranch&&lt(t,e),ct(t,e)):i.boundsChanged&&(e.add(t),t.isBranch&&(t.__tempNumber=0),ct(t,e)))})}(s,this.__levelList),function(t){let e,i,s;t.sort(!0),t.levels.forEach(n=>{e=t.levelMap[n];for(let t=0,n=e.length;t<n;t++){if(i=e[t],i.isBranch&&i.__tempNumber){s=i.children;for(let t=0,e=s.length;t<e;t++)s[t].isBranch||at(s[t])}at(i)}})}(this.__levelList),function(t){t.list.forEach(ht)}(s),this.extraBlock&&a.push(this.extraBlock),a.forEach(t=>t.setAfter()),i.emitEvent(new L(o,a,this.times)),i.emitEvent(new L(r,a,this.times)),this.addBlocks(a),this.__levelList.reset(),this.__updatedList=null,k.end(e)}fullLayout(){const t=k.start("FullLayout"),{target:e}=this,{BEFORE:i,LAYOUT:s,AFTER:n}=L,o=this.getBlocks(new f(e));e.emitEvent(new L(i,o,this.times)),_t.fullLayout(e),o.forEach(t=>{t.setAfter()}),e.emitEvent(new L(s,o,this.times)),e.emitEvent(new L(n,o,this.times)),this.addBlocks(o),k.end(t)}static fullLayout(t){ft(t,!0),t.isBranch?v.updateBounds(t):m.updateBounds(t),pt(t)}addExtra(t){if(!this.__updatedList.has(t)){const{updatedList:e,beforeBounds:i}=this.extraBlock||(this.extraBlock=new ut([]));e.length?i.add(t.__world):i.set(t.__world),e.add(t)}}createBlock(t){return new ut(t)}getBlocks(t){return[this.createBlock(t)]}addBlocks(t){this.layoutedBlocks?this.layoutedBlocks.push(...t):this.layoutedBlocks=t}__onReceiveWatchData(t){this.__updatedList=t.data.updatedList}__listenEvents(){this.__eventIds=[this.target.on_([[L.REQUEST,this.layout,this],[L.AGAIN,this.layoutAgain,this],[_.DATA,this.__onReceiveWatchData,this]])]}__removeListenEvents(){this.target.off_(this.__eventIds)}destroy(){this.target&&(this.stop(),this.__removeListenEvents(),this.target=this.config=null)}}const wt=t.get("Renderer");class mt{get needFill(){return!(this.canvas.allowBackgroundColor||!this.config.fill)}constructor(t,e,i){this.FPS=60,this.totalTimes=0,this.times=0,this.config={usePartRender:!0,ceilPartPixel:!0,maxFPS:120},this.frames=[],this.target=t,this.canvas=e,i&&(this.config=n.default(i,this.config)),this.__listenEvents()}start(){this.running=!0,this.update(!1)}stop(){this.running=!1}update(t=!0){this.changed||(this.changed=t),this.requestTime||this.__requestRender()}requestLayout(){this.target.emit(L.REQUEST)}checkRender(){if(this.running){const{target:t}=this;t.isApp&&(t.emit(p.CHILD_START,t),t.children.forEach(t=>{t.renderer.FPS=this.FPS,t.renderer.checkRender()}),t.emit(p.CHILD_END,t)),this.changed&&this.canvas.view&&this.render(),this.target.emit(p.NEXT)}}render(t){if(!this.running||!this.canvas.view)return this.update();const{target:e}=this;this.times=0,this.totalBounds=new x,wt.log(e.innerName,"---\x3e");try{this.emitRender(p.START),this.renderOnce(t),this.emitRender(p.END,this.totalBounds),B.clearRecycled()}catch(t){this.rendering=!1,wt.error(t)}wt.log("-------------|")}renderAgain(){this.rendering?this.waitAgain=!0:this.renderOnce()}renderOnce(t){if(this.rendering)return wt.warn("rendering");if(this.times>3)return wt.warn("render max times");if(this.times++,this.totalTimes++,this.rendering=!0,this.changed=!1,this.renderBounds=new x,this.renderOptions={},t)this.emitRender(p.BEFORE),t();else{if(this.requestLayout(),this.ignore)return void(this.ignore=this.rendering=!1);this.emitRender(p.BEFORE),this.config.usePartRender&&this.totalTimes>1?this.partRender():this.fullRender()}this.emitRender(p.RENDER,this.renderBounds,this.renderOptions),this.emitRender(p.AFTER,this.renderBounds,this.renderOptions),this.updateBlocks=null,this.rendering=!1,this.waitAgain&&(this.waitAgain=!1,this.renderOnce())}partRender(){const{canvas:t,updateBlocks:e}=this;e&&(this.mergeBlocks(),e.forEach(e=>{t.bounds.hit(e)&&!e.isEmpty()&&this.clipRender(e)}))}clipRender(t){const e=k.start("PartRender"),{canvas:i}=this,s=t.getIntersect(i.bounds),n=new x(s);i.save(),s.spread(mt.clipSpread).ceil();const{ceilPartPixel:o}=this.config;i.clipWorld(s,o),i.clearWorld(s,o),this.__render(s,n),i.restore(),k.end(e)}fullRender(){const t=k.start("FullRender"),{canvas:e}=this;e.save(),e.clear(),this.__render(e.bounds),e.restore(),k.end(t)}__render(e,s){const{canvas:n,target:o}=this,r=e.includes(o.__world),a=r?{includes:r}:{bounds:e,includes:r};this.needFill&&n.fillWorld(e,this.config.fill),t.showRepaint&&t.drawRepaint(n,e),this.config.useCellRender&&(a.cellList=this.getCellList()),i.render(o,n,a),this.renderBounds=s=s||e,this.renderOptions=a,this.totalBounds.isEmpty()?this.totalBounds=s:this.totalBounds.add(s),n.updateRender(s)}getCellList(){}addBlock(t){this.updateBlocks||(this.updateBlocks=[]),this.updateBlocks.push(t)}mergeBlocks(){const{updateBlocks:t}=this;if(t){const e=new x;e.setList(t),t.length=0,t.push(e)}}__requestRender(){const t=this.target;if(this.requestTime||!t)return;if(t.parentApp)return t.parentApp.requestRender(!1);this.requestTime=this.frameTime||Date.now();const e=()=>{const t=1e3/((this.frameTime=Date.now())-this.requestTime),{maxFPS:s}=this.config;if(s&&t>s)return i.requestRender(e);const{frames:n}=this;n.length>30&&n.shift(),n.push(t),this.FPS=Math.round(n.reduce((t,e)=>t+e,0)/n.length),this.requestTime=0,this.checkRender()};i.requestRender(e)}__onResize(t){if(!this.canvas.unreal){if(t.bigger||!t.samePixelRatio){const{width:e,height:i}=t.old;if(!new x(0,0,e,i).includes(this.target.__world)||this.needFill||!t.samePixelRatio)return this.addBlock(this.canvas.bounds),void this.target.forceUpdate("surface")}this.addBlock(new x(0,0,1,1)),this.update()}}__onLayoutEnd(t){t.data&&t.data.map(t=>{let e;t.updatedList&&t.updatedList.list.some(t=>(e=!t.__world.width||!t.__world.height,e&&(t.isLeafer||wt.tip(t.innerName,": empty"),e=!t.isBranch||t.isBranchLeaf),e)),this.addBlock(e?this.canvas.bounds:t.updatedBounds)})}emitRender(t,e,i){this.target.emitEvent(new p(t,this.times,e,i))}__listenEvents(){this.__eventIds=[this.target.on_([[p.REQUEST,this.update,this],[L.END,this.__onLayoutEnd,this],[p.AGAIN,this.renderAgain,this],[a.RESIZE,this.__onResize,this]])]}__removeListenEvents(){this.target.off_(this.__eventIds)}destroy(){this.target&&(this.stop(),this.__removeListenEvents(),this.config={},this.target=this.canvas=null)}}mt.clipSpread=10;const vt={},{copyRadiusPoint:yt}=T,{hitRadiusPoint:xt}=E;class bt{constructor(t,e){this.target=t,this.selector=e}getByPoint(t,e,i){e||(e=0),i||(i={});const s=i.through||!1,n=i.ignoreHittable||!1,o=i.target||this.target;this.exclude=i.exclude||null,this.point={x:t.x,y:t.y,radiusX:e,radiusY:e},this.findList=new f(i.findList),i.findList||this.hitBranch(o.isBranchLeaf?{children:[o]}:o);const{list:r}=this.findList,a=this.getBestMatchLeaf(r,i.bottomList,n,!!i.findList),h=n?this.getPath(a):this.getHitablePath(a);return this.clear(),s?{path:h,target:a,throughPath:r.length?this.getThroughPath(r):h}:{path:h,target:a}}hitPoint(t,e,i){return!!this.getByPoint(t,e,i).target}getBestMatchLeaf(t,e,i,s){const n=this.findList=new f;if(t.length){let e;const{x:s,y:o}=this.point,r={x:s,y:o,radiusX:0,radiusY:0};for(let s=0,o=t.length;s<o;s++)if(e=t[s],(i||m.worldHittable(e))&&(this.hitChild(e,r),n.length)){if(e.isBranchLeaf&&t.some(t=>t!==e&&m.hasParent(t,e))){n.reset();break}return n.list[0]}}if(e)for(let t=0,i=e.length;t<i;t++)if(this.hitChild(e[t].target,this.point,e[t].proxy),n.length)return n.list[0];return s?null:i?t[0]:t.find(t=>m.worldHittable(t))}getPath(t){const e=new f,i=[],{target:s}=this;for(;t&&(t.syncEventer&&i.push(t.syncEventer),e.add(t),(t=t.parent)!==s););return i.length&&i.forEach(t=>{for(;t&&(t.__.hittable&&e.add(t),(t=t.parent)!==s););}),s&&e.add(s),e}getHitablePath(t){const e=this.getPath(t&&t.hittable?t:null);let i,s=new f;for(let t=e.list.length-1;t>-1&&(i=e.list[t],i.__.hittable)&&(s.addAt(i,0),i.__.hitChildren&&(!i.isLeafer||"draw"!==i.mode));t--);return s}getThroughPath(t){const e=new f,i=[];for(let e=t.length-1;e>-1;e--)i.push(this.getPath(t[e]));let s,n,o;for(let t=0,r=i.length;t<r;t++){s=i[t],n=i[t+1];for(let t=0,i=s.length;t<i&&(o=s.list[t],!n||!n.has(o));t++)e.add(o)}return e}hitBranch(t){this.eachFind(t.children,t.__onlyHitMask)}eachFind(t,e){let i,s,n;const{point:o}=this;for(let r=t.length-1;r>-1;r--)if(i=t[r],n=i.__,n.visible&&(!e||n.mask))if(s=xt(i.__world,n.hitRadius?yt(vt,o,n.hitRadius):o),i.isBranch){if(s||i.__ignoreHitWorld){if(i.isBranchLeaf&&n.__clipAfterFill&&!i.__hitWorld(o,!0))continue;i.topChildren&&this.eachFind(i.topChildren,!1),this.eachFind(i.children,i.__onlyHitMask),i.isBranchLeaf&&this.hitChild(i,o)}}else s&&this.hitChild(i,o)}hitChild(t,e,i){if((!this.exclude||!this.exclude.has(t))&&t.__hitWorld(e)){const{parent:s}=t;if(s&&s.__hasMask&&!t.__.mask){let i,n=[];const{children:o}=s;for(let s=0,r=o.length;s<r;s++)if(i=o[s],i.__.mask&&n.push(i),i===t){if(n&&!n.every(t=>t.__hitWorld(e)))return;break}}this.findList.add(i||t)}}clear(){this.point=null,this.findList=null,this.exclude=null}destroy(){this.clear()}}class St{constructor(t,e){this.config={},e&&(this.config=n.default(e,this.config)),this.picker=new bt(this.target=t,this),this.finder=c.finder&&c.finder()}getByPoint(t,e,s){const{target:n,picker:o}=this;return i.backgrounder&&n&&n.updateLayout(),o.getByPoint(t,e,s)}hitPoint(t,e,i){return this.picker.hitPoint(t,e,i)}getBy(t,e,i,s){return this.finder?this.finder.getBy(t,e,i,s):P.need("find")}destroy(){this.picker.destroy(),this.finder&&this.finder.destroy()}}Object.assign(c,{watcher:(t,e)=>new ot(t,e),layouter:(t,e)=>new _t(t,e),renderer:(t,e,i)=>new mt(t,e,i),selector:(t,e)=>new St(t,e)}),i.layout=_t.fullLayout,i.render=function(t,e,i){const s=Object.assign(Object.assign({},i),{topRendering:!0});i.topList=new f,t.__render(e,i),i.topList.length&&i.topList.forEach(t=>t.__render(e,s))};const Lt={convert(t,e){const i=U.getBase(t),{x:s,y:n}=e,o=Object.assign(Object.assign({},i),{x:s,y:n,width:t.width,height:t.height,pointerType:t.pointerType,pressure:t.pressure});return"pen"===o.pointerType&&(o.tangentialPressure=t.tangentialPressure,o.tiltX=t.tiltX,o.tiltY=t.tiltY,o.twist=t.twist),o},convertMouse(t,e){const i=U.getBase(t),{x:s,y:n}=e;return Object.assign(Object.assign({},i),{x:s,y:n,width:1,height:1,pointerType:"mouse",pressure:.5})},convertTouch(t,e){const i=Lt.getTouch(t),s=U.getBase(t),{x:n,y:o}=e;return Object.assign(Object.assign({},s),{x:n,y:o,width:1,height:1,pointerType:"touch",multiTouch:t.touches.length>1,pressure:i.force})},getTouch:t=>t.targetTouches[0]||t.changedTouches[0]},kt={convert(t){const e=U.getBase(t);return Object.assign(Object.assign({},e),{code:t.code,key:t.key})}},{pathCanDrag:Bt}=U;class Tt extends G{get notPointer(){const{p:t}=this;return"pointer"!==t.type||t.touch||this.useMultiTouch}get notTouch(){const{p:t}=this;return"mouse"===t.type||this.usePointer}get notMouse(){return this.usePointer||this.useTouch}__listenEvents(){super.__listenEvents();const t=this.view=this.canvas.view;this.viewEvents={pointerdown:this.onPointerDown,mousedown:this.onMouseDown,touchstart:this.onTouchStart,pointerleave:this.onPointerLeave,contextmenu:this.onContextMenu,wheel:this.onWheel,gesturestart:this.onGesturestart,gesturechange:this.onGesturechange,gestureend:this.onGestureend},this.windowEvents={pointermove:this.onPointerMove,pointerup:this.onPointerUp,pointercancel:this.onPointerCancel,mousemove:this.onMouseMove,mouseup:this.onMouseUp,touchmove:this.onTouchMove,touchend:this.onTouchEnd,touchcancel:this.onTouchCancel,keydown:this.onKeyDown,keyup:this.onKeyUp,scroll:this.onScroll};const{viewEvents:e,windowEvents:i}=this;for(let i in e)e[i]=e[i].bind(this),t.addEventListener(i,e[i]);for(let t in i)i[t]=i[t].bind(this),window.addEventListener(t,i[t])}__removeListenEvents(){super.__removeListenEvents();const{viewEvents:t,windowEvents:e}=this;for(let e in t)this.view.removeEventListener(e,t[e]),this.viewEvents={};for(let t in e)window.removeEventListener(t,e[t]),this.windowEvents={}}getTouches(t){const e=[];for(let i=0,s=t.length;i<s;i++)e.push(t[i]);return e}preventDefaultPointer(t){const{pointer:e}=this.config;e.preventDefault&&t.preventDefault()}preventDefaultWheel(t){const{wheel:e}=this.config;e.preventDefault&&t.preventDefault()}preventWindowPointer(t){return!this.downData&&t.target!==this.view}onKeyDown(t){this.keyDown(kt.convert(t))}onKeyUp(t){this.keyUp(kt.convert(t))}onContextMenu(t){this.config.pointer.preventDefaultMenu&&t.preventDefault(),this.menu(Lt.convert(t,this.getLocal(t)))}onScroll(){this.canvas.updateClientBounds()}onPointerDown(t){this.preventDefaultPointer(t),this.notPointer||(this.usePointer||(this.usePointer=!0),this.pointerDown(Lt.convert(t,this.getLocal(t))))}onPointerMove(t,e){if(this.notPointer||this.preventWindowPointer(t))return;this.usePointer||(this.usePointer=!0);const i=Lt.convert(t,this.getLocal(t,!0));e?this.pointerHover(i):this.pointerMove(i)}onPointerLeave(t){this.onPointerMove(t,!0)}onPointerUp(t){this.downData&&this.preventDefaultPointer(t),this.notPointer||this.preventWindowPointer(t)||this.pointerUp(Lt.convert(t,this.getLocal(t)))}onPointerCancel(){this.useMultiTouch||this.pointerCancel()}onMouseDown(t){this.preventDefaultPointer(t),this.notMouse||this.pointerDown(Lt.convertMouse(t,this.getLocal(t)))}onMouseMove(t){this.notMouse||this.preventWindowPointer(t)||this.pointerMove(Lt.convertMouse(t,this.getLocal(t,!0)))}onMouseUp(t){this.downData&&this.preventDefaultPointer(t),this.notMouse||this.preventWindowPointer(t)||this.pointerUp(Lt.convertMouse(t,this.getLocal(t)))}onMouseCancel(){this.notMouse||this.pointerCancel()}onTouchStart(t){const e=Lt.getTouch(t),i=this.getLocal(e,!0),{preventDefault:s}=this.config.touch;(!0===s||"auto"===s&&Bt(this.findPath(i)))&&t.preventDefault(),this.multiTouchStart(t),this.notTouch||(this.touchTimer&&(window.clearTimeout(this.touchTimer),this.touchTimer=0),this.useTouch=!0,this.pointerDown(Lt.convertTouch(t,i)))}onTouchMove(t){if(this.multiTouchMove(t),this.notTouch||this.preventWindowPointer(t))return;const e=Lt.getTouch(t);this.pointerMove(Lt.convertTouch(t,this.getLocal(e)))}onTouchEnd(t){if(this.multiTouchEnd(),this.notTouch||this.preventWindowPointer(t))return;this.touchTimer&&clearTimeout(this.touchTimer),this.touchTimer=setTimeout(()=>{this.useTouch=!1},500);const e=Lt.getTouch(t);this.pointerUp(Lt.convertTouch(t,this.getLocal(e)))}onTouchCancel(){this.notTouch||this.pointerCancel()}multiTouchStart(t){this.useMultiTouch=t.touches.length>1,this.touches=this.useMultiTouch?this.getTouches(t.touches):void 0,this.useMultiTouch&&this.pointerCancel()}multiTouchMove(t){if(this.useMultiTouch&&t.touches.length>1){const e=this.getTouches(t.touches),i=this.getKeepTouchList(this.touches,e);i.length>1&&(this.multiTouch(U.getBase(t),i),this.touches=e)}}multiTouchEnd(){this.touches=null,this.useMultiTouch=!1,this.transformEnd()}getKeepTouchList(t,e){let i;const s=[];return t.forEach(t=>{i=e.find(e=>e.identifier===t.identifier),i&&s.push({from:this.getLocal(t),to:this.getLocal(i)})}),s}getLocalTouchs(t){return t.map(t=>this.getLocal(t))}onWheel(t){this.preventDefaultWheel(t),this.wheel(Object.assign(Object.assign(Object.assign({},U.getBase(t)),this.getLocal(t)),{deltaX:t.deltaX,deltaY:t.deltaY}))}onGesturestart(t){this.useMultiTouch||(this.preventDefaultWheel(t),this.lastGestureScale=1,this.lastGestureRotation=0)}onGesturechange(t){if(this.useMultiTouch)return;this.preventDefaultWheel(t);const e=U.getBase(t);Object.assign(e,this.getLocal(t));const i=t.scale/this.lastGestureScale,s=(t.rotation-this.lastGestureRotation)/Math.PI*180*(R.within(this.config.wheel.rotateSpeed,0,1)/4+.1);this.zoom(Object.assign(Object.assign({},e),{scale:i*i})),this.rotate(Object.assign(Object.assign({},e),{rotation:s})),this.lastGestureScale=t.scale,this.lastGestureRotation=t.rotation}onGestureend(t){this.useMultiTouch||(this.preventDefaultWheel(t),this.transformEnd())}setCursor(t){super.setCursor(t);const e=[];this.eachCursor(t,e),M(e[e.length-1])&&e.push("default"),this.canvas.view.style.cursor=e.map(t=>M(t)?`url(${t.url}) ${t.x||0} ${t.y||0}`:t).join(",")}eachCursor(t,e,i=0){if(i++,b(t))t.forEach(t=>this.eachCursor(t,e,i));else{const n=s(t)&&Y.get(t);n&&i<2?this.eachCursor(n,e,i):e.push(t)}}destroy(){this.view&&(super.destroy(),this.view=null,this.touches=null)}}function Et(t,e,i){t.__.__font?V.fillText(t,e,i):t.__.windingRule?e.fill(t.__.windingRule):e.fill()}function Pt(t,e,i,s,n){const o=i.__;M(t)?V.drawStrokesStyle(t,e,!1,i,s,n):(s.setStroke(t,o.__strokeWidth*e,o),s.stroke()),o.__useArrow&&V.strokeArrow(t,i,s,n)}function Rt(t,e,i,s,n){const o=i.__;M(t)?V.drawStrokesStyle(t,e,!0,i,s,n):(s.setStroke(t,o.__strokeWidth*e,o),V.drawTextStroke(i,s,n))}function Mt(t,e,i,s,n){const o=s.getSameCanvas(!0,!0);o.font=i.__.__font,Rt(t,2,i,o,n),o.blendMode="outside"===e?"destination-out":"destination-in",V.fillText(i,o,n),o.blendMode="normal",m.copyCanvasByWorld(i,s,o),o.recycle(i.__nowWorld)}const{getSpread:Ct,copyAndSpread:At,toOuterOf:Ot,getOuterOf:Dt,getByMove:Wt,move:It,getIntersectData:Ft}=E,zt={};let jt;const{stintSet:Ut}=n,{hasTransparent:Gt}=q;function Yt(t,e,i){if(!M(e)||!1===e.visible||0===e.opacity)return;let n;const{boxBounds:o}=i.__layout;switch(e.type){case"image":if(!e.url)return;n=N.image(i,t,e,o,!jt||!jt[e.url]);break;case"linear":n=H.linearGradient(e,o);break;case"radial":n=H.radialGradient(e,o);break;case"angular":n=H.conicGradient(e,o);break;case"solid":const{type:s,color:a,opacity:h}=e;n={type:s,style:q.string(a,h)};break;default:r(e.r)||(n={type:"solid",style:q.string(e)})}if(n&&(n.originPaint=e,s(n.style)&&Gt(n.style)&&(n.isTransparent=!0),e.style)){if(0===e.style.strokeWidth)return;n.strokeStyle=e.style}return n}const Xt={compute:function(t,e){const i=e.__,s=[];let n,o,r,a=i.__input[t];b(a)||(a=[a]),jt=N.recycleImage(t,i);for(let i,n=0,o=a.length;n<o;n++)(i=Yt(t,a[n],e))&&(s.push(i),i.strokeStyle&&(r||(r=1),i.strokeStyle.strokeWidth&&(r=Math.max(r,i.strokeStyle.strokeWidth))));i["_"+t]=s.length?s:void 0,s.length?(s.every(t=>t.isTransparent)&&(s.some(t=>t.image)&&(n=!0),o=!0),"fill"===t?(Ut(i,"__isAlphaPixelFill",n),Ut(i,"__isTransparentFill",o)):(Ut(i,"__isAlphaPixelStroke",n),Ut(i,"__isTransparentStroke",o),Ut(i,"__hasMultiStrokeStyle",r))):i.__removePaint(t,!1)},fill:function(t,e,i,s){i.fillStyle=t,Et(e,i,s)},fills:function(t,e,i,s){let n,o,r;for(let a=0,h=t.length;a<h;a++){if(n=t[a],o=n.originPaint,n.image){if(r?r++:r=1,N.checkImage(n,!e.__.__font,e,i,s))continue;if(!n.style){1===r&&n.image.isPlacehold&&e.drawImagePlaceholder(n,i,s);continue}}if(i.fillStyle=n.style,n.transform||o.scaleFixed){if(i.save(),n.transform&&i.transform(n.transform),o.scaleFixed){const{scaleX:t,scaleY:s}=e.getRenderScaleData(!0);(!0===o.scaleFixed||"zoom-in"===o.scaleFixed&&t>1&&s>1)&&i.scale(1/t,1/s)}o.blendMode&&(i.blendMode=o.blendMode),Et(e,i,s),i.restore()}else o.blendMode?(i.saveBlendMode(o.blendMode),Et(e,i,s),i.restoreBlendMode()):Et(e,i,s)}},fillPathOrText:Et,fillText:function(t,e,i){const s=t.__,{rows:n,decorationY:o}=s.__textDrawData;let r;s.__isPlacehold&&s.placeholderColor&&(e.fillStyle=s.placeholderColor);for(let t=0,i=n.length;t<i;t++)r=n[t],r.text?e.fillText(r.text,r.x,r.y):r.data&&r.data.forEach(t=>{e.fillText(t.char,t.x,r.y)});if(o){const{decorationColor:t,decorationHeight:i}=s.__textDrawData;t&&(e.fillStyle=t),n.forEach(t=>o.forEach(s=>e.fillRect(t.x,t.y+s,t.width,i)))}},stroke:function(t,e,i,s){const n=e.__;if(n.__strokeWidth)if(n.__font)V.strokeText(t,e,i,s);else switch(n.strokeAlign){case"center":Pt(t,1,e,i,s);break;case"inside":!function(t,e,i,s){i.save(),i.clipUI(e),Pt(t,2,e,i,s),i.restore()}(t,e,i,s);break;case"outside":!function(t,e,i,s){const n=e.__;if(n.__fillAfterStroke)Pt(t,2,e,i,s);else{const{renderBounds:o}=e.__layout,r=i.getSameCanvas(!0,!0);e.__drawRenderPath(r),Pt(t,2,e,r,s),r.clipUI(n),r.clearWorld(o),m.copyCanvasByWorld(e,i,r),r.recycle(e.__nowWorld)}}(t,e,i,s)}},strokes:function(t,e,i,s){V.stroke(t,e,i,s)},strokeText:function(t,e,i,s){switch(e.__.strokeAlign){case"center":Rt(t,1,e,i,s);break;case"inside":Mt(t,"inside",e,i,s);break;case"outside":e.__.__fillAfterStroke?Rt(t,2,e,i,s):Mt(t,"outside",e,i,s)}},drawTextStroke:function(t,e,i){let s,n=t.__.__textDrawData;const{rows:o,decorationY:r}=n;for(let t=0,i=o.length;t<i;t++)s=o[t],s.text?e.strokeText(s.text,s.x,s.y):s.data&&s.data.forEach(t=>{e.strokeText(t.char,t.x,s.y)});if(r){const{decorationHeight:t}=n;o.forEach(i=>r.forEach(s=>e.strokeRect(i.x,i.y+s,i.width,t)))}},drawStrokesStyle:function(t,e,i,s,n,o){let r;const a=s.__,{__hasMultiStrokeStyle:h}=a;h||n.setStroke(void 0,a.__strokeWidth*e,a);for(let l=0,c=t.length;l<c;l++)if(r=t[l],(!r.image||!N.checkImage(r,!1,s,n,o))&&r.style){if(h){const{strokeStyle:t}=r;t?n.setStroke(r.style,a.__getRealStrokeWidth(t)*e,a,t):n.setStroke(r.style,a.__strokeWidth*e,a)}else n.strokeStyle=r.style;r.originPaint.blendMode?(n.saveBlendMode(r.originPaint.blendMode),i?V.drawTextStroke(s,n,o):n.stroke(),n.restoreBlendMode()):i?V.drawTextStroke(s,n,o):n.stroke()}},shape:function(t,e,s){const n=e.getSameCanvas(),o=e.bounds,r=t.__nowWorld,a=t.__layout,h=t.__nowWorldShapeBounds||(t.__nowWorldShapeBounds={});let l,c,d,u,f,p;Ot(a.strokeSpread?(At(zt,a.boxBounds,a.strokeSpread),zt):a.boxBounds,r,h);let{scaleX:g,scaleY:_}=t.getRenderScaleData(!0);if(o.includes(h))p=n,l=f=h,c=r;else{let n;if(i.fullImageShadow)n=h;else{const t=a.renderShapeSpread?Ct(o,C.swapAndScale(a.renderShapeSpread,g,_)):o;n=Ft(t,h)}u=o.getFitMatrix(n);let{a:w,d:m}=u;u.a<1&&(p=e.getSameCanvas(),t.__renderShape(p,s),g*=w,_*=m),f=Dt(h,u),l=Wt(f,-u.e,-u.f),c=Dt(r,u),It(c,-u.e,-u.f);const v=s.matrix;v?(d=new A(u),d.multiply(v),w*=v.scaleX,m*=v.scaleY):d=u,d.withScale(w,m),s=Object.assign(Object.assign({},s),{matrix:d})}return t.__renderShape(n,s),{canvas:n,matrix:d,fitMatrix:u,bounds:l,renderBounds:c,worldCanvas:p,shapeBounds:f,scaleX:g,scaleY:_}}};let Vt,Nt=new x;const{isSame:qt}=E;function Ht(t,e,i,s,n,o){if("fill"===e&&!t.__.__naturalWidth){const e=t.__;if(e.__naturalWidth=s.width/e.pixelRatio,e.__naturalHeight=s.height/e.pixelRatio,e.__autoSide)return t.forceUpdate("width"),t.__proxyData&&(t.setProxyAttr("width",e.width),t.setProxyAttr("height",e.height)),!1}return n.data||N.createData(n,s,i,o),!0}function Kt(t,e){Zt(t,O.LOAD,e)}function Qt(t,e){Zt(t,O.LOADED,e)}function $t(t,e,i){e.error=i,t.forceUpdate("surface"),Zt(t,O.ERROR,e)}function Zt(t,e,i){t.hasEvent(e)&&t.emitEvent(new O(e,i))}function Jt(t,e){const{leafer:i}=t;i&&i.viewReady&&(i.renderer.ignore=e)}const{get:te,translate:ee}=D,ie=new x,se={},ne={};function oe(t,e,i,n){const o=s(t)||n?(n?i-n*e:i%e)/((n||Math.floor(i/e))-1):t;return"auto"===t&&o<0?0:o}let re={},ae=F();const{get:he,set:le,rotateOfOuter:ce,translate:de,scaleOfOuter:ue,multiplyParent:fe,scale:pe,rotate:ge,skew:_e}=D;function we(t,e,i,s,n,o,r,a){r&&ge(t,r),a&&_e(t,a.x,a.y),n&&pe(t,n,o),de(t,e.x+i,e.y+s)}function me(t,e,i,s){return new(i||(i=Promise))(function(n,o){function r(t){try{h(s.next(t))}catch(t){o(t)}}function a(t){try{h(s.throw(t))}catch(t){o(t)}}function h(t){var e;t.done?n(t.value):(e=t.value,e instanceof i?e:new i(function(t){t(e)})).then(r,a)}h((s=s.apply(t,e||[])).next())})}"function"==typeof SuppressedError&&SuppressedError;const{get:ve,scale:ye,copy:xe}=D,{getFloorScale:be}=R,{abs:Se}=Math;const Le={image:function(t,e,i,s,n){let o,r;const a=B.get(i);return Vt&&i===Vt.paint&&qt(s,Vt.boxBounds)?o=Vt.leafPaint:(o={type:i.type,image:a},a.hasAlphaPixel&&(o.isTransparent=!0),Vt=a.use>1?{leafPaint:o,paint:i,boxBounds:Nt.set(s)}:null),(n||a.loading)&&(r={image:a,attrName:e,attrValue:i}),a.ready?(Ht(t,e,i,a,o,s),n&&(Kt(t,r),Qt(t,r))):a.error?n&&$t(t,r,a.error):(n&&(Jt(t,!0),Kt(t,r)),o.loadId=a.load(()=>{Jt(t,!1),t.destroyed||(Ht(t,e,i,a,o,s)&&(a.hasAlphaPixel&&(t.__layout.hitCanvasChanged=!0),t.forceUpdate("surface")),Qt(t,r)),o.loadId=void 0},e=>{Jt(t,!1),$t(t,r,e),o.loadId=void 0},i.lod&&a.getThumbSize(i.lod)),t.placeholderColor&&(t.placeholderDelay?setTimeout(()=>{a.ready||(a.isPlacehold=!0,t.forceUpdate("surface"))},t.placeholderDelay):a.isPlacehold=!0)),o},checkImage:function(t,e,s,n,o){const{scaleX:r,scaleY:h}=N.getImageRenderScaleData(t,s,n,o),{image:l,data:c,originPaint:d}=t,{exporting:u,snapshot:f}=o;return!(!c||t.patternId===r+"-"+h&&!u||f)&&(e&&(c.repeat?e=!1:d.changeful||"miniapp"===i.name&&a.isResizing(s)||u||(e=i.image.isLarge(l,r,h)||l.width*r>8096||l.height*h>8096)),e?(s.__.__isFastShadow&&(n.fillStyle=t.style||"#000",n.fill()),N.drawImage(t,r,h,s,n,o),!0):(!t.style||d.sync||u?N.createPattern(t,s,n,o):N.createPatternTask(t,s,n,o),!1))},drawImage:function(t,e,i,s,n,o){const{data:r,image:a}=t,{blendMode:h}=t.originPaint,{opacity:l,transform:c}=r,d=a.getFull(r.filters),u=s.__;let f,{width:p,height:g}=a;(f=c&&!c.onlyScale||u.path||u.cornerRadius)||l||h?(n.save(),f&&n.clipUI(s),h&&(n.blendMode=h),l&&(n.opacity*=l),c&&n.transform(c),n.drawImage(d,0,0,p,g),n.restore()):(r.scaleX&&(p*=r.scaleX,g*=r.scaleY),n.drawImage(d,0,0,p,g))},getImageRenderScaleData:function(t,e,i,s){const n=e.getRenderScaleData(!0,t.originPaint.scaleFixed),{data:o}=t;if(i){const{pixelRatio:t}=i;n.scaleX*=t,n.scaleY*=t}return o&&o.scaleX&&(n.scaleX*=Math.abs(o.scaleX),n.scaleY*=Math.abs(o.scaleY)),n},recycleImage:function(t,e){const i=e["_"+t];if(b(i)){let s,n,o,r,a;for(let h=0,l=i.length;h<l;h++)s=i[h],n=s.image,a=n&&n.url,a&&(o||(o={}),o[a]=!0,B.recyclePaint(s),n.loading&&(r||(r=e.__input&&e.__input[t]||[],b(r)||(r=[r])),n.unload(i[h].loadId,!r.some(t=>t.url===a))));return o}return null},createPatternTask:function(t,e,i,s){t.patternTask||(t.patternTask=B.patternTasker.add(()=>me(this,void 0,void 0,function*(){N.createPattern(t,e,i,s),e.forceUpdate("surface")}),0,()=>(t.patternTask=null,i.bounds.hit(e.__nowWorld))))},createPattern:function(t,e,s,n){let{scaleX:o,scaleY:r}=N.getImageRenderScaleData(t,e,s,n),a=o+"-"+r;if(t.patternId!==a&&!e.destroyed&&(!i.image.isLarge(t.image,o,r)||t.data.repeat)){const{image:s,data:n}=t,{transform:h,gap:l}=n,c=N.getPatternFixScale(t,o,r);let d,u,f,{width:p,height:g}=s;c&&(o*=c,r*=c),p*=o,g*=r,l&&(u=l.x*o/Se(n.scaleX||1),f=l.y*r/Se(n.scaleY||1)),(h||1!==o||1!==r)&&(o*=be(p+(u||0)),r*=be(g+(f||0)),d=ve(),h&&xe(d,h),ye(d,1/o,1/r));const _=s.getCanvas(p,g,n.opacity,n.filters,u,f,e.leafer&&e.leafer.config.smooth,n.interlace),w=s.getPattern(_,n.repeat||i.origin.noRepeat||"no-repeat",d,t);t.style=w,t.patternId=a}},getPatternFixScale:function(t,e,s){const{image:n}=t;let o,r=i.image.maxPatternSize,a=n.width*n.height;return n.isSVG?e>1&&(o=Math.ceil(e)/e):r>a&&(r=a),(a*=e*s)>r&&(o=Math.sqrt(r/a)),o},createData:function(t,e,i,s){t.data=N.getPatternData(i,s,e)},getPatternData:function(t,e,i){t.padding&&(e=ie.set(e).shrink(t.padding)),"strench"===t.mode&&(t.mode="stretch");const{width:n,height:o}=i,{opacity:r,mode:a,align:h,offset:l,scale:c,size:d,rotation:u,skew:f,clipSize:p,repeat:g,gap:_,filters:w,interlace:m}=t,v=e.width===n&&e.height===o,y={mode:a},x="center"!==h&&(u||0)%180==90;let b,S;switch(E.set(ne,0,0,x?o:n,x?n:o),a&&"cover"!==a&&"fit"!==a?((c||d)&&(R.getScaleData(c,d,i,se),b=se.scaleX,S=se.scaleY),(h||_||g)&&(b&&E.scale(ne,b,S,!0),h&&W.toPoint(h,ne,e,ne,!0,!0))):v&&!u||(b=S=E.getFitScale(e,ne,"fit"!==a),E.put(e,i,h,b,!1,ne),E.scale(ne,b,S,!0)),l&&T.move(ne,l),a){case"stretch":v?b&&(b=S=void 0):(b=e.width/n,S=e.height/o,N.stretchMode(y,e,b,S));break;case"normal":case"clip":if(ne.x||ne.y||b||p||u||f){let t,i;p&&(t=e.width/p.width,i=e.height/p.height),N.clipMode(y,e,ne.x,ne.y,b,S,u,f,t,i),t&&(b=b?b*t:t,S=S?S*i:i)}break;case"repeat":(!v||b||u||f)&&N.repeatMode(y,e,n,o,ne.x,ne.y,b,S,u,f,h,t.freeTransform),g||(y.repeat="repeat");const i=M(g);(_||i)&&(y.gap=function(t,e,i,s,n){let o,r;M(t)?(o=t.x,r=t.y):o=r=t;return{x:oe(o,i,n.width,e&&e.x),y:oe(r,s,n.height,e&&e.y)}}(_,i&&g,ne.width,ne.height,e));break;default:b&&N.fillOrFitMode(y,e,ne.x,ne.y,b,S,u)}return y.transform||(e.x||e.y)&&ee(y.transform=te(),e.x,e.y),b&&(y.scaleX=b,y.scaleY=S),r&&r<1&&(y.opacity=r),w&&(y.filters=w),g&&(y.repeat=s(g)?"x"===g?"repeat-x":"repeat-y":"repeat"),m&&(y.interlace=I(m)||"percent"===m.type?{type:"x",offset:m}:m),y},stretchMode:function(t,e,i,s){const n=he(),{x:o,y:r}=e;o||r?de(n,o,r):n.onlyScale=!0,pe(n,i,s),t.transform=n},fillOrFitMode:function(t,e,i,s,n,o,r){const a=he();de(a,e.x+i,e.y+s),pe(a,n,o),r&&ce(a,{x:e.x+e.width/2,y:e.y+e.height/2},r),t.transform=a},clipMode:function(t,e,i,s,n,o,r,a,h,l){const c=he();we(c,e,i,s,n,o,r,a),h&&(r||a?(le(ae),ue(ae,e,h,l),fe(c,ae)):ue(c,e,h,l)),t.transform=c},repeatMode:function(t,e,i,s,n,o,r,a,h,l,c,d){const u=he();if(d)we(u,e,n,o,r,a,h,l);else{if(h)if("center"===c)ce(u,{x:i/2,y:s/2},h);else switch(ge(u,h),h){case 90:de(u,s,0);break;case 180:de(u,i,s);break;case 270:de(u,0,i)}re.x=e.x+n,re.y=e.y+o,de(u,re.x,re.y),r&&ue(u,re,r,a)}t.transform=u}},{toPoint:ke}=z,{hasTransparent:Be}=q,Te={},Ee={};function Pe(t,e,i,n){if(i){let o,r,a,h;for(let t=0,l=i.length;t<l;t++)o=i[t],s(o)?(a=t/(l-1),r=q.string(o,n)):(a=o.offset,r=q.string(o.color,n)),e.addColorStop(a,r),!h&&Be(r)&&(h=!0);h&&(t.isTransparent=!0)}}const{getAngle:Re,getDistance:Me}=T,{get:Ce,rotateOfOuter:Ae,scaleOfOuter:Oe}=D,{toPoint:De}=z,We={},Ie={};function Fe(t,e,i,s,n){let o;const{width:r,height:a}=t;if(r!==a||s){const t=Re(e,i);o=Ce(),n?(Oe(o,e,r/a*(s||1),1),Ae(o,e,t+90)):(Oe(o,e,1,r/a*(s||1)),Ae(o,e,t))}return o}const{getDistance:ze}=T,{toPoint:je}=z,Ue={},Ge={};const Ye={linearGradient:function(t,e){let{from:s,to:n,type:o,opacity:r}=t;ke(s||"top",e,Te),ke(n||"bottom",e,Ee);const a=i.canvas.createLinearGradient(Te.x,Te.y,Ee.x,Ee.y),h={type:o,style:a};return Pe(h,a,t.stops,r),h},radialGradient:function(t,e){let{from:s,to:n,type:o,opacity:r,stretch:a}=t;De(s||"center",e,We),De(n||"bottom",e,Ie);const h=i.canvas.createRadialGradient(We.x,We.y,0,We.x,We.y,Me(We,Ie)),l={type:o,style:h};Pe(l,h,t.stops,r);const c=Fe(e,We,Ie,a,!0);return c&&(l.transform=c),l},conicGradient:function(t,e){let{from:s,to:n,type:o,opacity:r,stretch:a}=t;je(s||"center",e,Ue),je(n||"bottom",e,Ge);const h=i.conicGradientSupport?i.canvas.createConicGradient(0,Ue.x,Ue.y):i.canvas.createRadialGradient(Ue.x,Ue.y,0,Ue.x,Ue.y,ze(Ue,Ge)),l={type:o,style:h};Pe(l,h,t.stops,r);const c=Fe(e,Ue,Ge,a||1,i.conicGradientRotate90);return c&&(l.transform=c),l},getTransform:Fe},{copy:Xe,move:Ve,toOffsetOutBounds:Ne}=E,{max:qe,abs:He}=Math,Ke={},Qe=new A,$e={};function Ze(t,e){let i,s,n,o,r=0,a=0,h=0,l=0;return e.forEach(t=>{i=t.x||0,s=t.y||0,o=1.5*(t.blur||0),n=He(t.spread||0),r=qe(r,n+o-s),a=qe(a,n+o+i),h=qe(h,n+o+s),l=qe(l,n+o-i)}),r===a&&a===h&&h===l?r:[r,a,h,l]}function Je(t,e,s){const{shapeBounds:n}=s;let o,r;i.fullImageShadow?(Xe(Ke,t.bounds),Ve(Ke,e.x-n.x,e.y-n.y),o=t.bounds,r=Ke):(o=n,r=e),t.copyWorld(s.canvas,o,r)}const{toOffsetOutBounds:ti}=E,ei={};const ii=Ze;const si={shadow:function(t,e,i){let s,n;const{__nowWorld:o}=t,{shadow:r}=t.__,{worldCanvas:a,bounds:h,renderBounds:l,shapeBounds:c,scaleX:d,scaleY:u}=i,f=e.getSameCanvas(),p=r.length-1;Ne(h,$e,l),r.forEach((r,g)=>{let _=1;if(r.scaleFixed){const t=Math.abs(o.scaleX);t>1&&(_=1/t)}f.setWorldShadow($e.offsetX+(r.x||0)*d*_,$e.offsetY+(r.y||0)*u*_,(r.blur||0)*d*_,q.string(r.color)),n=K.getShadowTransform(t,f,i,r,$e,_),n&&f.setTransform(n),Je(f,$e,i),n&&f.resetTransform(),s=l,r.box&&(f.restore(),f.save(),a&&(f.copyWorld(f,l,o,"copy"),s=o),a?f.copyWorld(a,o,o,"destination-out"):f.copyWorld(i.canvas,c,h,"destination-out")),m.copyCanvasByWorld(t,e,f,s,r.blendMode),p&&g<p&&f.clearWorld(s)}),f.recycle(s)},innerShadow:function(t,e,i){let s,n;const{__nowWorld:o}=t,{innerShadow:r}=t.__,{worldCanvas:a,bounds:h,renderBounds:l,shapeBounds:c,scaleX:d,scaleY:u}=i,f=e.getSameCanvas(),p=r.length-1;ti(h,ei,l),r.forEach((r,g)=>{let _=1;if(r.scaleFixed){const t=Math.abs(o.scaleX);t>1&&(_=1/t)}f.save(),f.setWorldShadow(ei.offsetX+(r.x||0)*d*_,ei.offsetY+(r.y||0)*u*_,(r.blur||0)*d*_),n=K.getShadowTransform(t,f,i,r,ei,_,!0),n&&f.setTransform(n),Je(f,ei,i),f.restore(),a?(f.copyWorld(f,l,o,"copy"),f.copyWorld(a,o,o,"source-out"),s=o):(f.copyWorld(i.canvas,c,h,"source-out"),s=l),f.fillWorld(s,q.string(r.color),"source-in"),m.copyCanvasByWorld(t,e,f,s,r.blendMode),p&&g<p&&f.clearWorld(s)}),f.recycle(s)},blur:function(t,e,i){const{blur:s}=t.__;i.setWorldBlur(s*t.__nowWorld.a),i.copyWorldToInner(e,t.__nowWorld,t.__layout.renderBounds),i.filter="none"},backgroundBlur:function(t,e,i){},getShadowRenderSpread:Ze,getShadowTransform:function(t,e,i,s,n,o,r){if(s.spread){const i=2*s.spread*o*(r?-1:1),{width:a,height:h}=t.__layout.strokeBounds;return Qe.set().scaleOfOuter({x:(n.x+n.width/2)*e.pixelRatio,y:(n.y+n.height/2)*e.pixelRatio},1+i/a,1+i/h),Qe}},isTransformShadow(t){},getInnerShadowSpread:ii},{excludeRenderBounds:ni}=y;let oi;function ri(t,e,i,s,n,o,r,a){switch(e){case"grayscale":oi||(oi=!0,n.useGrayscaleAlpha(t.__nowWorld));case"alpha":!function(t,e,i,s,n,o){const r=t.__nowWorld;i.resetTransform(),i.opacity=1,i.useMask(s,r),o&&s.recycle(r);hi(t,e,i,1,n,o)}(t,i,s,n,r,a);break;case"opacity-path":hi(t,i,s,o,r,a);break;case"path":a&&i.restore()}}function ai(t){return t.getSameCanvas(!1,!0)}function hi(t,e,i,s,n,o){const r=t.__nowWorld;e.resetTransform(),e.opacity=s,e.copyWorld(i,r,void 0,n),o?i.recycle(r):i.clearWorld(r)}Q.prototype.__renderMask=function(t,e){let i,s,n,o,r,a;const{children:h}=this;for(let l=0,c=h.length;l<c;l++){if(i=h[l],a=i.__.mask,a){r&&(ri(this,r,t,n,s,o,void 0,!0),s=n=null),"clipping"!==a&&"clipping-path"!==a||ni(i,e)||i.__render(t,e),o=i.__.opacity,oi=!1,"path"===a||"clipping-path"===a?(o<1?(r="opacity-path",n||(n=ai(t))):(r="path",t.save()),i.__clip(n||t,e)):(r="grayscale"===a?"grayscale":"alpha",s||(s=ai(t)),n||(n=ai(t)),i.__render(s,e));continue}const c=1===o&&i.__.__blendMode;c&&ri(this,r,t,n,s,o,void 0,!1),ni(i,e)||i.__render(n||t,e),c&&ri(this,r,t,n,s,o,c,!1)}ri(this,r,t,n,s,o,void 0,!0)};const li=">)]}%!?,.:;'\"》）」〉』〗】〕｝┐＞’”！？，、。：；‰",ci=li+"_#~&*+\\=|≮≯≈≠＝…",di=new RegExp([[19968,40959],[13312,19903],[131072,173791],[173824,177983],[177984,178207],[178208,183983],[183984,191471],[196608,201551],[201552,205743],[11904,12031],[12032,12255],[12272,12287],[12288,12351],[12736,12783],[12800,13055],[13056,13311],[63744,64255],[65072,65103],[127488,127743],[194560,195103]].map(([t,e])=>`[\\u${t.toString(16)}-\\u${e.toString(16)}]`).join("|"));function ui(t){const e={};return t.split("").forEach(t=>e[t]=!0),e}const fi=ui("ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz"),pi=ui("{[(<'\"《（「〈『〖【〔｛┌＜‘“＝¥￥＄€£￡¢￠"),gi=ui(li),_i=ui(ci),wi=ui("- —／～｜┆·");var mi;!function(t){t[t.Letter=0]="Letter",t[t.Single=1]="Single",t[t.Before=2]="Before",t[t.After=3]="After",t[t.Symbol=4]="Symbol",t[t.Break=5]="Break"}(mi||(mi={}));const{Letter:vi,Single:yi,Before:xi,After:bi,Symbol:Si,Break:Li}=mi;function ki(t){return fi[t]?vi:wi[t]?Li:pi[t]?xi:gi[t]?bi:_i[t]?Si:di.test(t)?yi:vi}const Bi={trimRight(t){const{words:e}=t;let i,s=0,n=e.length;for(let o=n-1;o>-1&&(i=e[o].data[0]," "===i.char);o--)s++,t.width-=i.width;s&&e.splice(n-s,s)}};function Ti(t,e,i){switch(e){case"title":return i?t.toUpperCase():t;case"upper":return t.toUpperCase();case"lower":return t.toLowerCase();default:return t}}const{trimRight:Ei}=Bi,{Letter:Pi,Single:Ri,Before:Mi,After:Ci,Symbol:Ai,Break:Oi}=mi;let Di,Wi,Ii,Fi,zi,ji,Ui,Gi,Yi,Xi,Vi,Ni,qi,Hi,Ki,Qi,$i,Zi=[];function Ji(t,e){Yi&&!Gi&&(Gi=Yi),Di.data.push({char:t,width:e}),Ii+=e}function ts(){Fi+=Ii,Di.width=Ii,Wi.words.push(Di),Di={data:[]},Ii=0}function es(){Hi&&(Ki.paraNumber++,Wi.paraStart=!0,Hi=!1),Yi&&(Wi.startCharSize=Gi,Wi.endCharSize=Yi,Gi=0),Wi.width=Fi,Qi.width?Ei(Wi):$i&&is(),Zi.push(Wi),Wi={words:[]},Fi=0}function is(){Fi>(Ki.maxWidth||0)&&(Ki.maxWidth=Fi)}const{top:ss,right:ns,bottom:os,left:rs}=j;function as(t,e,i){const{bounds:s,rows:n}=t;s[e]+=i;for(let t=0;t<n.length;t++)n[t][e]+=i}const hs={getDrawData:function(t,e){s(t)||(t=String(t));let n=0,o=0,r=e.__getInput("width")||0,a=e.__getInput("height")||0;const{__padding:h}=e;h&&(r?(n=h[rs],r-=h[ns]+h[rs],!r&&(r=.01)):e.autoSizeAlign||(n=h[rs]),a?(o=h[ss],a-=h[ss]+h[os],!a&&(a=.01)):e.autoSizeAlign||(o=h[ss]));const l={bounds:{x:n,y:o,width:r,height:a},rows:[],paraNumber:0,font:i.canvas.font=e.__font};return function(t,e,s){Ki=t,Zi=t.rows,Qi=t.bounds,$i=!Qi.width&&!s.autoSizeAlign;const{__letterSpacing:n,paraIndent:o,textCase:r}=s,{canvas:a}=i,{width:h}=Qi;if(s.__isCharMode){const t="none"!==s.textWrap,i="break"===s.textWrap;Hi=!0,Vi=null,Gi=Ui=Yi=Ii=Fi=0,Di={data:[]},Wi={words:[]},n&&(e=[...e]);for(let s=0,l=e.length;s<l;s++)ji=e[s],"\n"===ji?(Ii&&ts(),Wi.paraEnd=!0,es(),Hi=!0):(Xi=ki(ji),Xi===Pi&&"none"!==r&&(ji=Ti(ji,r,!Ii)),Ui=a.measureText(ji).width,n&&(n<0&&(Yi=Ui),Ui+=n),Ni=Xi===Ri&&(Vi===Ri||Vi===Pi)||Vi===Ri&&Xi!==Ci,qi=!(Xi!==Mi&&Xi!==Ri||Vi!==Ai&&Vi!==Ci),zi=Hi&&o?h-o:h,t&&h&&Fi+Ii+Ui>zi&&(i?(Ii&&ts(),Fi&&es()):(qi||(qi=Xi===Pi&&Vi==Ci),Ni||qi||Xi===Oi||Xi===Mi||Xi===Ri||Ii+Ui>zi?(Ii&&ts(),Fi&&es()):Fi&&es()))," "===ji&&!0!==Hi&&Fi+Ii===0||(Xi===Oi?(" "===ji&&Ii&&ts(),Ji(ji,Ui),ts()):Ni||qi?(Ii&&ts(),Ji(ji,Ui)):Ji(ji,Ui)),Vi=Xi);Ii&&ts(),Fi&&es(),Zi.length>0&&(Zi[Zi.length-1].paraEnd=!0)}else e.split("\n").forEach(t=>{Ki.paraNumber++,Fi=a.measureText(t).width,Zi.push({x:o||0,text:t,width:Fi,paraStart:!0}),$i&&is()})}(l,t,e),h&&function(t,e,i,s,n){if(!s&&i.autoSizeAlign)switch(i.textAlign){case"left":as(e,"x",t[rs]);break;case"right":as(e,"x",-t[ns])}if(!n&&i.autoSizeAlign)switch(i.verticalAlign){case"top":as(e,"y",t[ss]);break;case"bottom":as(e,"y",-t[os])}}(h,l,e,r,a),function(t,e){const{rows:i,bounds:s}=t,n=i.length,{__lineHeight:o,__baseLine:r,__letterSpacing:a,__clipText:h,textAlign:l,verticalAlign:c,paraSpacing:d,autoSizeAlign:u}=e;let{x:f,y:p,width:g,height:_}=s,w=o*n+(d?d*(t.paraNumber-1):0),m=r;if(h&&w>_)w=Math.max(_,o),n>1&&(t.overflow=n);else if(_||u)switch(c){case"middle":p+=(_-w)/2;break;case"bottom":p+=_-w}m+=p;let v,y,x,b=g||u?g:t.maxWidth;for(let r=0,c=n;r<c;r++){if(v=i[r],v.x=f,v.width<g||v.width>g&&!h)switch(l){case"center":v.x+=(b-v.width)/2;break;case"right":v.x+=b-v.width}v.paraStart&&d&&r>0&&(m+=d),v.y=m,m+=o,t.overflow>r&&m>w&&(v.isOverflow=!0,t.overflow=r+1),y=v.x,x=v.width,a<0&&(v.width<0?(x=-v.width+e.fontSize+a,y-=x,x+=e.fontSize):x-=a),y<s.x&&(s.x=y),x>s.width&&(s.width=x),h&&g&&g<x&&(v.isOverflow=!0,t.overflow||(t.overflow=i.length))}s.y=p,s.height=w}(l,e),e.__isCharMode&&function(t,e,i){const{rows:s}=t,{textAlign:n,paraIndent:o,__letterSpacing:r}=e,a=i&&n.includes("both"),h=a||i&&n.includes("justify"),l=h&&n.includes("letter");let c,d,u,f,p,g,_,w,m,v;s.forEach(t=>{t.words&&(p=o&&t.paraStart?o:0,w=t.words.length,h&&(v=!t.paraEnd||a,d=i-t.width-p,l?f=d/(t.words.reduce((t,e)=>t+e.data.length,0)-1):u=w>1?d/(w-1):0),g=r||t.isOverflow||l?0:u?1:2,t.isOverflow&&!r&&(t.textMode=!0),2===g?(t.x+=p,function(t){t.text="",t.words.forEach(e=>{e.data.forEach(e=>{t.text+=e.char})})}(t)):(t.x+=p,c=t.x,t.data=[],t.words.forEach((e,i)=>{1===g?(_={char:"",x:c},c=function(t,e,i){return t.forEach(t=>{i.char+=t.char,e+=t.width}),e}(e.data,c,_),(t.isOverflow||" "!==_.char)&&t.data.push(_)):c=function(t,e,i,s,n){return t.forEach(t=>{(s||" "!==t.char)&&(t.x=e,i.push(t)),e+=t.width,n&&(e+=n)}),e}(e.data,c,t.data,t.isOverflow,v&&f),v&&(m=i===w-1,u?m||(c+=u,t.width+=u):f&&(t.width+=f*(e.data.length-(m?1:0))))})),t.words=null)})}(l,e,r),l.overflow&&function(t,e,s,n){if(!n)return;const{rows:o,overflow:r}=t;let{textOverflow:a}=e;if(o.splice(r),a&&"show"!==a){let t,h;"hide"===a?a="":"ellipsis"===a&&(a="...");const l=a?i.canvas.measureText(a).width:0,c=s+n-l;("none"===e.textWrap?o:[o[r-1]]).forEach(e=>{if(e.isOverflow&&e.data){let i=e.data.length-1;for(let s=i;s>-1&&(t=e.data[s],h=t.x+t.width,!(s===i&&h<c));s--){if(h<c&&" "!==t.char||!s){e.data.splice(s+1),e.width-=t.width;break}e.width-=t.width}e.width+=l,e.data.push({char:a,x:h}),e.textMode&&function(t){t.text="",t.data.forEach(e=>{t.text+=e.char}),t.data=null}(e)}})}}(l,e,n,r),"none"!==e.textDecoration&&function(t,e){let i,s=0;const{fontSize:n,textDecoration:o}=e;switch(t.decorationHeight=n/11,M(o)?(i=o.type,o.color&&(t.decorationColor=q.string(o.color)),o.offset&&(s=Math.min(.3*n,Math.max(o.offset,.15*-n)))):i=o,i){case"under":t.decorationY=[.15*n+s];break;case"delete":t.decorationY=[.35*-n];break;case"under-delete":t.decorationY=[.15*n+s,.35*-n]}}(l,e),l}};const ls={string:function(t,e){if(!t)return"#000";const i=I(e)&&e<1;if(s(t)){if(!i||!q.object)return t;t=q.object(t)}let n=r(t.a)?1:t.a;i&&(n*=e);const o=t.r+","+t.g+","+t.b;return 1===n?"rgb("+o+")":"rgba("+o+","+n+")"}};Object.assign($,hs),Object.assign(q,ls),Object.assign(V,Xt),Object.assign(N,Le),Object.assign(H,Ye),Object.assign(K,si),Object.assign(c,{interaction:(t,e,i,s)=>new Tt(t,e,i,s),hitCanvas:(t,e)=>new tt(t,e),hitCanvasManager:()=>new X}),st();export{Tt as Interaction,_t as Layouter,tt as LeaferCanvas,Z as PathNodeHandleType,bt as Picker,mt as Renderer,St as Selector,ot as Watcher,st as useCanvas};
//# sourceMappingURL=web.esm.min.js.map
